<div class="flex justify-center items-center flex-col w-full h-full gap-3" *ngIf="!loaded">
  <div class="prose">
    <h1>Cargando</h1>
  </div>
  <progress class="progress w-56"></progress>
  <div class="prose">
    <p>Por favor espere un momento</p>
  </div>
</div>

<div class="w-full flex justify-center" *ngIf="loaded">
  <div class="w-full md:w-4/5 lg:w-3/4 mb-3">
    <div class="prose mb-4">
      <h1>Usuarios</h1>
      <p>Lista los usuarios y administra los roles eficientemente.</p>
    </div>

    <div class="flex flex-col lg:flex-row lg:justify-start gap-4 mb-4">
      <form [formGroup]="filtrosForm" class="flex flex-col lg:flex-row gap-2" (submit)="aplicarFiltros()">
        <div>
          <label for="role" class="block mb-2 text-sm font-medium text-gray-700">Rol</label>
          <select id="role" formControlName="role" class="select select-bordered">
            <option value="" disabled selected>Rol</option>
            <option value="ADMIN">Administrador</option>
            <option value="PANADERO">Panadero</option>
            <option value="CLIENTE">Cliente</option>
            <option value="">Todos</option>
          </select>
        </div>
        <div class="flex items-end h-full">
          <button type="submit" class="btn btn-primary mt-4 lg:mt-0">Aplicar</button>
        </div>
      </form>
    </div>

    <div class="overflow-x-auto border rounded-lg mt-2">
      <table class="table w-full">
        <thead>
          <tr>
            <th>Id</th>
            <th>Correo</th>
            <th>Rol</th>
            <th>Estado</th> <!-- Nueva columna -->
            <th class="text-right">Administrar</th>
          </tr>
        </thead>
        <tbody>
          <tr class="hover" *ngFor="let usuario of usuariosPaginados">
            <th>{{ usuario.id }}</th>
            <td>{{ usuario.email }}</td>
            <td>{{ usuario.role }}</td>
            <td>
              <span class="badge" [ngClass]="usuario.isDeleted ? 'badge-error' : 'badge-success'">
                {{ usuario.isDeleted ? 'Inactivo' : 'Activo' }}
              </span>
            </td>
            <td class="text-right">
              <div class="flex flex-col sm:flex-row sm:space-x-2 justify-end">
                <button class="btn btn-outline btn-primary mb-2 sm:mb-0" (click)="roleUsuario(usuario.id)">Cambiar Rol</button>
                <button class="btn btn-outline btn-danger" (click)="openModalEliminar(usuario.id)">Dar de Baja</button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      <div class="flex items-center justify-end mt-4 p-1 gap-1">
        <span class="mx-2">Página {{ paginaActual }} de {{ totalPaginas }}</span>
        <button class="btn btn-sm" [disabled]="paginaActual === 1" (click)="cambiarPagina(paginaActual - 1)">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" class="inline-block h-5 w-5 stroke-current">
            <path stroke-linecap="round" stroke-linejoin="round" d="m18.75 4.5-7.5 7.5 7.5 7.5m-6-15L5.25 12l7.5 7.5" />
          </svg>
        </button>
        <button class="btn btn-sm" [disabled]="paginaActual === totalPaginas" (click)="cambiarPagina(paginaActual + 1)">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" class="inline-block h-5 w-5 stroke-current">
            <path stroke-linecap="round" stroke-linejoin="round" d="m5.25 4.5 7.5 7.5-7.5 7.5" />
          </svg>
        </button>
      </div>
    </div>
  </div>
</div>

<dialog #modalCambiarRol class="modal">
  <div class="modal-box">
    <form method="dialog">
      <button type="button" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" (click)="closeModal()">✕</button>
      <h3 class="text-lg font-bold">Cambiar Rol del Usuario</h3>
      <div class="py-4">
        <label for="role-select" class="block text-sm font-medium text-gray-700">Selecciona un nuevo rol</label>
        <select id="role-select" [(ngModel)]="selectedRole" name="role" class="mt-1 block w-full border-b">
          <option value=""></option>
          <option value="ADMIN">Administrador</option>
          <option value="PANADERO">Panadero</option>
          <option value="CLIENTE">Cliente</option>
        </select>
      </div>
      <div class="modal-action">
        <button type="button" class="btn btn-primary" (click)="cambiarRol()" [disabled]="selectedRole == ''">Guardar</button>
      </div>
    </form>
  </div>
</dialog>

<dialog #modalConfirmarEliminar class="modal">
  <div class="modal-box">
    <form method="dialog">
      <button type="button" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" (click)="closeModalEliminar()">✕</button>
      <h3 class="text-lg font-bold">Confirmar Eliminación</h3>
      <p>¿Estás seguro de que deseas eliminar a este usuario?</p>
      <div class="modal-action">
        <button type="button" class="btn btn-error" (click)="confirmarEliminar()">Eliminar</button>
        <button type="button" class="btn" (click)="closeModalEliminar()">Cancelar</button>
      </div>
    </form>
  </div>
</dialog>

<app-toast #toast></app-toast>
